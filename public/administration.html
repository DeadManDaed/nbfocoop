<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration - NBFO Coop√©rative</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2E7D32, #66BB6A);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-title p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn-dashboard {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-dashboard:hover {
            background: rgba(255,255,255,0.3);
        }

        .btn-logout {
            background: rgba(244, 67, 54, 0.8);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        /* Navigation tabs */
        .nav-tabs {
            background: white;
            padding: 0 40px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 18px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            color: #2E7D32;
            background: #f9f9f9;
        }

        .nav-tab.active {
            color: #2E7D32;
            border-bottom-color: #2E7D32;
            background: #f9f9f9;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: #2E7D32;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2E7D32;
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2E7D32, #66BB6A);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53935, #d32f2f);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43a047, #388e3c);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #fb8c00, #f57c00);
            color: white;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9f9f9;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #666;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        tr:hover {
            background: #fafafa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-admin { background: #e3f2fd; color: #1976d2; }
        .badge-caisse { background: #fff3e0; color: #f57c00; }
        .badge-stock { background: #e8f5e9; color: #388e3c; }
        .badge-pending { background: #fff3e0; color: #f57c00; }
        .badge-approved { background: #e8f5e9; color: #388e3c; }
        .badge-rejected { background: #ffebee; color: #d32f2f; }

        /* Message styles */
        .message-item {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #2E7D32;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .message-sender {
            font-weight: 600;
            color: #2E7D32;
        }

        .message-date {
            color: #999;
            font-size: 13px;
        }

        .message-body {
            color: #666;
            line-height: 1.6;
        }

        /* Alert messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .alert-success {
            background: #e8f5e9;
            border: 1px solid #66bb6a;
            color: #2e7d32;
        }

        .alert-error {
            background: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
        }

        .alert-warning {
            background: #fff3e0;
            border: 1px solid #ffa726;
            color: #f57c00;
        }

        /* Action buttons in table */
        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        /* Stats cards for validation */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #2E7D32;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2E7D32;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Loading spinner */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-radius: 50%;
            border-top-color: #2E7D32;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 968px) {
            .container {
                padding: 20px;
            }
            
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                padding: 0 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .action-btns {
                flex-direction: column;
            }
        }
    </style>
    </head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <div class="logo">üë®‚Äçüíº</div>
            <div class="header-title">
                <h1>Administration</h1>
                <p>Gestion globale de la coop√©rative</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-dashboard" onclick="window.location.href='/dashboard.html'">
                <span>üè†</span> Tableau de bord
            </button>
            <button class="btn-logout" onclick="logout()">D√©connexion</button>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <div class="nav-tab active" onclick="switchTab('users')">
            <span>üë•</span> Utilisateurs
        </div>
        <div class="nav-tab" onclick="switchTab('messages')">
            <span>üí¨</span> Messages
        </div>
        <div class="nav-tab" onclick="switchTab('producers')">
            <span>üåæ</span> Producteurs
        </div>
        <div class="nav-tab" onclick="switchTab('validation')">
            <span>‚úì</span> Validation
        </div>
        <div class="nav-tab" onclick="switchTab('reports')">
            <span>üìä</span> Rapports
        </div>
        <div class="nav-tab" onclick="switchTab('settings')">
            <span>‚öôÔ∏è</span> Param√®tres
        </div>
    </div>

    <!-- Container -->
    <div class="container">
        <div id="alertBox" class="alert"></div>

        <!-- TAB: Utilisateurs -->
        <div id="tab-users" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üë•</span> Cr√©er un utilisateur</h2>
                </div>
                <form id="createUserForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="newUsername">Nom d'utilisateur *</label>
                            <input type="text" id="newUsername" required placeholder="Ex: jean.dupont">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">Mot de passe *</label>
                            <input type="password" id="newPassword" required placeholder="Min. 6 caract√®res">
                        </div>
                        <div class="form-group">
                            <label for="newRole">R√¥le *</label>
                            <select id="newRole" required>
                                <option value="">S√©lectionner un r√¥le</option>
                                <option value="admin">Administrateur</option>
                                <option value="caisse">Gestionnaire de caisse</option>
                                <option value="stock">Gestionnaire de stock</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>‚ûï</span> Cr√©er l'utilisateur
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üìã</span> Liste des utilisateurs</h2>
                    <button class="btn btn-secondary" onclick="loadUsers()">
                        <span>üîÑ</span> Actualiser
                    </button>
                </div>
                <div class="table-container" id="usersTableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des utilisateurs...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Messages -->
        <div id="tab-messages" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üí¨</span> Envoyer un message</h2>
                </div>
                <form id="sendMessageForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="messageRecipient">Destinataire *</label>
                            <select id="messageRecipient" required>
                                <option value="">Chargement...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="messageType">Type de message *</label>
                            <select id="messageType" required>
                                <option value="info">Information</option>
                                <option value="urgent">Urgent</option>
                                <option value="task">T√¢che</option>
                                <option value="alert">Alerte</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="messageSubject">Objet *</label>
                        <input type="text" id="messageSubject" required placeholder="Objet du message">
                    </div>
                    <div class="form-group">
                        <label for="messageBody">Message *</label>
                        <textarea id="messageBody" required placeholder="Votre message..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>üì§</span> Envoyer le message
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üì•</span> Messages re√ßus</h2>
                    <button class="btn btn-secondary" onclick="loadMessages()">
                        <span>üîÑ</span> Actualiser
                    </button>
                </div>
                <div id="messagesContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des messages...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Producteurs -->
        <div id="tab-producers" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üåæ</span> Ajouter un producteur</h2>
                </div>
                <form id="addProducerForm">          
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="producerName">Nom du producteur *</label>
                            <input type="text" id="producerName" required placeholder="Ex: Kon√© Martin">
                        </div>
                        <div class="form-group">
                            <label for="producerPhone">T√©l√©phone *</label>
                            <input type="tel" id="producerPhone" required placeholder="Ex: +237 6XX XX XX XX">
                        </div>
                        <div class="form-group">
                            <label for="producerType">Type *</label>
                            <select id="producerType" required>
                                <option value="agriculteur">Agriculteur</option>
                                <option value="√©leveur">√âleveur</option>
                                <option value="p√™cheur">P√™cheur</option>
                                <option value="artisan">Artisan</option>
                                <option value="alimentaire manufacture">Alimentaire manufacture</option>
                                <option value="coop√©rative">Coop√©rative</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">                                               
                            <label>R√©gion :</label>
                            <select id="region"></select>
                            <label> D√©partement </label>
                            <select id="departement"></select>
                            <label>Arrondissement :</label>
                            <select id="arrondissement"></select>
                            <label>D√©tenteur de carte :</label>
                            <input type="checkbox" id="carteMembre" />                      
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="producerProducts">Produits propos√©s</label>
                        <textarea id="producerProducts" placeholder="Ex: Banane plantain, Manioc, Ma√Øs"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>‚ûï</span> Ajouter le producteur
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
    <h2 class="card-title"><span>üìã</span> Liste des producteurs</h2>
                    <button class="btn btn-secondary" onclick="loadProducers()">
                        <span>üîÑ</span> Actualiser
                    </button>
                </div>
                <div class="table-container" id="producersTableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des producteurs...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB: Validation -->
        <div id="tab-validation" class="tab-content">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="pendingCount">0</div>
                    <div class="stat-label">En attente</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="approvedCount">0</div>
                    <div class="stat-label">Valid√©es</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="rejectedCount">0</div>
                    <div class="stat-label">Rejet√©es</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>‚úì</span> Modifications en attente</h2>
                    <button class="btn btn-secondary" onclick="loadValidations()">
                        <span>üîÑ</span> Actualiser
                    </button>
                </div>
                <div class="table-container" id="validationsTableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des validations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Rapports -->
        <div id="tab-reports" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üìä</span> G√©n√©rer un rapport</h2>
                </div>
                <form id="generateReportForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="reportType">Type de rapport *</label>
                            <select id="reportType" required>
                                <option value="users">Activit√© utilisateurs</option>
                                <option value="operations">Op√©rations de caisse</option>
                                <option value="stock">Mouvements de stock</option>
                                <option value="producers">Activit√© producteurs</option>
                                <option value="audit">Audit complet</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportPeriod">P√©riode *</label>
                            <select id="reportPeriod" required>
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                                <option value="quarter">Ce trimestre</option>
                                <option value="year">Cette ann√©e</option>
                                <option value="custom">Personnalis√©e</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>üìÑ</span> G√©n√©rer le rapport
                    </button>
                </form>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üìã</span> Historique des audits</h2>
                </div>
                <div class="table-container" id="auditTableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement de l'historique...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Param√®tres -->
        <div id="tab-settings" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>‚öôÔ∏è</span> Param√®tres g√©n√©raux</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="coopName">Nom de la coop√©rative</label>
                        <input type="text" id="coopName" value="NBFO Coop√©rative">
                    </div>
                    <div class="form-group">
                        <label for="currency">Unit√© mon√©taire interne</label>
                        <input type="text" id="currency" value="Cr√©dit NBFO">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">
                    <span>üíæ</span> Enregistrer les param√®tres
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title"><span>üîê</span> S√©curit√©</h2>
                </div>
                <button class="btn btn-warning" onclick="changePassword()">
                    <span>üîë</span> Changer mon mot de passe
                </button>
            </div>
        </div>
    </div>

    
    <script>
        let currentUser = null;

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            const userInfo = sessionStorage.getItem('userInfo');
            if (!userInfo) {
                window.location.href = '/index.html';
                return;
            }

            currentUser = JSON.parse(userInfo);
            
            // V√©rifier que l'utilisateur est admin
            if (currentUser.role !== 'admin') {
                showAlert('Acc√®s refus√© : vous devez √™tre administrateur', 'error');
                setTimeout(() => window.location.href = '/dashboard.html', 2000);
                return;
            }
// Charger les r√©gions au d√©marrage
    function loadRegions() {
        fetch('/api/regions')
          .then(res => res.json())
          .then(regions => {
            const regionSelect = document.getElementById('region');
            regions.forEach(r => {
              const opt = document.createElement('option');
              opt.value = r.id;
              opt.textContent = r.nom;
              regionSelect.appendChild(opt);
            });
          });
            }
            // Charger les donn√©es initiales
            loadUsers();
            loadMessages();
            loadProducers();
            loadValidations();
            loadAudit();
            loadUsersForMessages();
            loadRegions();
        });

        // Gestion des tabs
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.closest('.nav-tab').classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // Affichage des alertes
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 5000);
        }

        // === GESTION DES UTILISATEURS ===

async function submitFormToTable(formName, tableName, data) {
  const formElement = document.getElementById(formName);
  const submitButton = formElement.querySelector('button[type="submit"]');
  const originalText = submitButton.textContent;

  try {
    const response = await fetch(`/api/${tableName}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`Erreur ${response.status}`);
    }

    const result = await response.json();
    console.log('R√©ponse compl√®te:', result);

    // Message succ√®s
    submitButton.textContent = '‚úì Succ√®s !';
    submitButton.style.backgroundColor = '#10b981'; // vert
    submitButton.disabled = true;

    // R√©initialiser le formulaire
    formElement.reset();

    // Restaurer apr√®s 3 secondes
    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.style.backgroundColor = '';
      submitButton.disabled = false;
    }, 3000);

  } catch (err) {
    console.error('Erreur:', err);

    // Message √©chec
    submitButton.textContent = '‚úó √âchec...';
    submitButton.style.backgroundColor = '#ef4444'; // rouge

    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.style.backgroundColor = '';
    }, 3000);
  }
}
        
/*
        
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;

            if (password.length < 6) {
                showAlert('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
                return;
            }

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, role })
                });

                if (response.ok) {
                    showAlert('Utilisateur cr√©√© avec succ√®s', 'success');
                    e.target.reset();
                    loadUsers();
                } else {
                    showAlert('Erreur lors de la cr√©ation de l\'utilisateur', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de connexion au serveur', 'error');
            }
        });
*/
        async function loadUsers() {
            const container = document.getElementById('usersTableContainer');
            
            try {
                const response = await fetch('/api/users');
                const users = await response.json();

                if (users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun utilisateur trouv√©</p>';
                    return;
                }

                const html = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom d'utilisateur</th>
                                <th>R√¥le</th>
                                <th>Date de cr√©ation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.id}</td>
                                    <td>${user.username}</td>
                                    <td><span class="badge badge-${user.role}">${getRoleLabel(user.role)}</span></td>
                                    <td>${new Date(user.created_at).toLocaleDateString('fr-FR')}</td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="btn-icon btn-danger" onclick="deleteUser(${user.id}, '${user.username}')" title="Supprimer">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                container.innerHTML = html;
            } catch (error) {
                console.error('Erreur:', error);
                container.innerHTML = '<p style="color: #c62828; text-align: center; padding: 40px;">Erreur de chargement</p>';
            }
        }
function getRoleLabel(role) {
            const roles = {
                'admin': 'Administrateur',
                'caisse': 'Gestionnaire de caisse',
                'stock': 'Gestionnaire de stock'
            };
            return roles[role] || role;
        }

        async function deleteUser(userId, username) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('Utilisateur supprim√© avec succ√®s', 'success');
                    loadUsers();
                } else {
                    showAlert('Erreur lors de la suppression', 'error');
                }
            } catch (error) {
                showAlert('Erreur de connexion', 'error');
            }
        }

        // === GESTION DES MESSAGES ===
        async function loadUsersForMessages() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                const select = document.getElementById('messageRecipient');
                
                select.innerHTML = '<option value="">S√©lectionner un destinataire</option>' +
                    '<option value="all">Tous les utilisateurs</option>' +
                    users.filter(u => u.username !== currentUser.username)
                        .map(u => `<option value="${u.username}">${u.username} (${getRoleLabel(u.role)})</option>`)
                        .join('');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        document.getElementById('sendMessageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageData = {
                sender: currentUser.username,
                recipient: document.getElementById('messageRecipient').value,
                type: document.getElementById('messageType').value,
                subject: document.getElementById('messageSubject').value,
                body: document.getElementById('messageBody').value,
                date: new Date().toISOString()
            };

            try {
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });

                if (response.ok) {
                    showAlert('Message envoy√© avec succ√®s', 'success');
                    e.target.reset();
                    loadMessages();
                } else {
                    showAlert('Erreur lors de l\'envoi du message', 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('Erreur de connexion', 'error');
            }
        });

        async function loadMessages() {
            const container = document.getElementById('messagesContainer');
            
            try {
                const response = await fetch(`/api/messages?user=${currentUser.username}`);
                const messages = await response.json();

                if (messages.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun message</p>';
                    return;
                }

                const container = document.getElementById('messagesContainer');
container.innerHTML = ''; // on vide

messages.forEach(msg => {
  const item = document.createElement('div');
  item.className = 'message-item';

  const header = document.createElement('div');
  header.className = 'message-header';

  const sender = document.createElement('span');
  sender.className = 'message-sender';
  sender.textContent = `De: ${msg.sender}`;

  const date = document.createElement('span');
  date.className = 'message-date';
  date.textContent = new Date(msg.date).toLocaleString('fr-FR');

  header.appendChild(sender);
  header.appendChild(date);

  const subject = document.createElement('strong');
  subject.textContent = msg.subject;

  const body = document.createElement('div');
  body.className = 'message-body';
  body.textContent = msg.body; // ‚ö†Ô∏è textContent = s√©curit√©

  item.appendChild(header);
  item.appendChild(subject);
  item.appendChild(body);

  container.appendChild(item);
});

            } catch (error) {
                container.innerHTML = '<p style="color: #c62828; text-align: center; padding: 40px;">Erreur de chargement</p>';
            }
        }

    // Remplissage dynamique des listes R√©gion ‚Üí D√©partement ‚Üí Arrondissement
            
// Quand une r√©gion est choisie ‚Üí charger les d√©partements
document.getElementById('region').addEventListener('change', async (e) => {
  const depSelect = document.getElementById('departement');
  depSelect.innerHTML = '';
  const res = await fetch(`/api/departements/${e.target.value}`);
  const deps = await res.json();
  deps.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = d.nom;
    depSelect.appendChild(opt);
  });
});

// Quand un d√©partement est choisi ‚Üí charger les arrondissements
document.getElementById('departement').addEventListener('change', async (e) => {
  const arrSelect = document.getElementById('arrondissement');
  arrSelect.innerHTML = '';
  const res = await fetch(`/api/arrondissements/${e.target.value}`);
  const arrs = await res.json();
  arrs.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = a.nom;
    arrSelect.appendChild(opt);
  });
});
            async function loadProducers() {
            const container = document.getElementById('producersTableContainer');
            
            try {
                const response = await fetch('/api/producteurs');
                const producers = await response.json();

                if (producers.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun producteur enregistr√©</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>T√©l√©phone</th>
                                <th>Type</th>
                                <th>R√©gion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${producers.map(p => `
                                <tr>
                                    <td>${p.nom_producteur}</td>
                                    <td>${p.tel_producteur}</td>
                                    <td><span class="badge badge-stock">${p.type_producteur}</span></td>
                                    <td>${p.region || '-'}</td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="btn-icon btn-secondary" onclick="editProducer(${p.id})" title="Modifier">‚úèÔ∏è</button>
                                            <button class="btn-icon btn-danger" onclick="deleteProducer(${p.id})" title="Supprimer">üóëÔ∏è</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = '<p style="color: #c62828; text-align: center; padding: 40px;">Erreur de chargement</p>';
            }
        }

        function editProducer(id) {
            alert('Fonction de modification √† impl√©menter - ID: ' + id);
        }

        async function deleteProducer(id) {
            if (!confirm('Supprimer ce producteur ?')) return;
            
            try {
                const response = await fetch(`/api/producteurs/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showAlert('Producteur supprim√©', 'success');
                    loadProducers();
                }
            } catch (error) {
                showAlert('Erreur de suppression', 'error');
            }
        }

// Soumission du formulaire producteur
document.getElementById('addProducerForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const regionSelect = document.getElementById('region');
  const depSelect = document.getElementById('departement');
  const arrSelect = document.getElementById('arrondissement');

  const data = {
    nom_producteur: document.getElementById('producerName').value.trim(),
    tel_producteur: document.getElementById('producerPhone').value.trim(),
    type_producteur: document.getElementById('producerType').value,
    region: parseInt(regionSelect.value),
    departement_id: parseInt(depSelect.value),
    arrondissement_id: parseInt(arrSelect.value),
    carte_membre: document.getElementById('carteMembre').checked,
    points_fidelite: 0,
    solde: 0,
    localite: '',
    produits: document.getElementById('producerProducts').value.trim() // ‚ö†Ô∏è ajouter () ici
  };

  console.log('=== D√âBOGAGE DES DONN√âES ===');
  console.log('Donn√©es compl√®tes:', data);
  console.log('R√©gion:', regionSelect.value);
  console.log('D√©partement:', depSelect.value);
  console.log('Arrondissement:', arrSelect.value);
  console.log('JSON √† envoyer:', JSON.stringify(data, null, 2));

  try {
    const response = await fetch('/api/producteurs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      throw new Error(`Erreur ${response.status}`);
    }

    const result = await response.json();
    console.log('R√©ponse compl√®te:', result);

    const submitButton = document.querySelector('#addProducerForm button[type="submit"]');
    const originalText = submitButton.textContent;

    // Afficher le message de succ√®s sur le bouton
    submitButton.textContent = '‚úì Enregistr√© avec succ√®s !';
    submitButton.style.backgroundColor = '#10b981'; // Vert succ√®s
    submitButton.disabled = true;

    // R√©initialiser le formulaire
    document.getElementById('addProducerForm').reset();

    // Restaurer le bouton apr√®s 3 secondes
    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.style.backgroundColor = ''; // Couleur originale
      submitButton.disabled = false;
    }, 3000);

  } catch (err) {
    console.error('Erreur lors de l\'enregistrement du producteur', err);

    const submitButton = document.querySelector('#addProducerForm button[type="submit"]');
    const originalText = submitButton.textContent;

    // Afficher le message d'erreur sur le bouton
    submitButton.textContent = '‚úó Erreur lors de l\'enregistrement';
    submitButton.style.backgroundColor = '#ef4444'; // Rouge erreur

    setTimeout(() => {
      submitButton.textContent = originalText;
      submitButton.style.backgroundColor = '';
    }, 3000);
  }
});

        // === GESTION DES VALIDATIONS ===
        async function loadValidations() {
            const container = document.getElementById('validationsTableContainer');
            
            try {
                const response = await fetch('/api/validations');
                const validations = await response.json();

                const pending = validations.filter(v => v.status === 'pending').length;
                const approved = validations.filter(v => v.status === 'approved').length;
                const rejected = validations.filter(v => v.status === 'rejected').length;

                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('approvedCount').textContent = approved;
                document.getElementById('rejectedCount').textContent = rejected;

                const pendingItems = validations.filter(v => v.status === 'pending');

                if (pendingItems.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucune modification en attente</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Utilisateur</th>
                                <th>D√©tails</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${pendingItems.map(v => `
                                <tr>
                                    <td><span class="badge badge-pending">${v.type}</span></td>
                                    <td>${v.utilisateur}</td>
                                    <td>${v.details}</td>
                                    <td>${new Date(v.date).toLocaleString('fr-FR')}</td>
                                    <td>
                                        <div class="action-btns">
                                            <button class="btn btn-success" onclick="approveValidation(${v.id})">‚úì Valider</button>
                                            <button class="btn btn-danger" onclick="rejectValidation(${v.id})">‚úó Rejeter</button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = '<p style="color: #c62828; text-align: center; padding: 40px;">Erreur de chargement</p>';
            }
        }

        async function approveValidation(id) {
            try {
                const response = await fetch(`/api/validations/${id}/approve`, { method: 'POST' });
                if (response.ok) {
                    showAlert('Modification valid√©e', 'success');
                    loadValidations();
                }
            } catch (error) {
                showAlert('Erreur', 'error');
            }
        }

        async function rejectValidation(id) {
            const reason = prompt('Raison du rejet:');
            if (!reason) return;
            
            try {
                const response = await fetch(`/api/validations/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (response.ok) {
                    showAlert('Modification rejet√©e', 'warning');
                    loadValidations();
                }
            } catch (error) {
                showAlert('Erreur', 'error');
            }
        }

        // === GESTION DES RAPPORTS ===
        document.getElementById('generateReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('reportType').value;
            const period = document.getElementById('reportPeriod').value;
            
            showAlert(`G√©n√©ration du rapport ${type} pour ${period}...`, 'success');
        });

        async function loadAudit() {
            const container = document.getElementById('auditTableContainer');
            
            try {
                const response = await fetch('/api/audit');
                const audit = await response.json();

                if (audit.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Aucun audit</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Action</th>
                                <th>Table</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${audit.slice(0, 20).map(a => `
                                <tr>
                                    <td>${a.utilisateur}</td>
                                    <td>${a.action}</td>
                                    <td>${a.table_cible}</td>
                                    <td>${new Date(a.date_action).toLocaleString('fr-FR')}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                container.innerHTML = '<p style="color: #c62828;">Erreur de chargement</p>';
            }
        }

        // === PARAM√àTRES ===
        function saveSettings() {
            showAlert('Param√®tres enregistr√©s avec succ√®s', 'success');
        }

        function changePassword() {
            const newPassword = prompt('Nouveau mot de passe:');
            if (newPassword && newPassword.length >= 6) {
                showAlert('Mot de passe modifi√© avec succ√®s', 'success');
            } else if (newPassword) {
                showAlert('Le mot de passe doit contenir au moins 6 caract√®res', 'error');
            }
        }

        // D√©connexion
        function logout() {
            sessionStorage.removeItem('userInfo');
            window.location.href = '/index.html';
        }
    </script>
</body>
</html>
